name: Build Release

on:
  push:
    tags: ['v*']
  workflow_dispatch:  # Allow manual trigger

env:
  CARGO_TERM_COLOR: always

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      # Public builds use default (empty) secrets/support stubs

      - name: Build Release
        run: cargo build --release

      - name: Download Inno Setup
        run: choco install innosetup -y

      - name: Create Installer
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer\windows-setup.iss

      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: LittleHelper-Windows
          path: Output/LittleHelper-Setup.exe

  # Build on Intel Mac runner
  build-mac-intel:
    runs-on: macos-15-intel
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      # Public builds use default (empty) secrets/support stubs

      - name: Build Release (Intel)
        run: cargo build --release

      - name: Upload Intel binary
        uses: actions/upload-artifact@v4
        with:
          name: mac-intel-binary
          path: target/release/app

  # Build on Apple Silicon runner
  build-mac-arm:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      # Public builds use default (empty) secrets/support stubs

      - name: Build Release (Apple Silicon)
        run: cargo build --release

      - name: Upload ARM binary
        uses: actions/upload-artifact@v4
        with:
          name: mac-arm-binary
          path: target/release/app

  # Combine Intel and ARM binaries into universal binary
  build-mac-universal:
    needs: [build-mac-intel, build-mac-arm]
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Download Intel binary
        uses: actions/download-artifact@v4
        with:
          name: mac-intel-binary
          path: intel

      - name: Download ARM binary
        uses: actions/download-artifact@v4
        with:
          name: mac-arm-binary
          path: arm

      - name: Create Universal Binary
        run: |
          mkdir -p universal
          lipo -create intel/app arm/app -output universal/app
          # Verify it's universal
          file universal/app

      - name: Create App Bundle
        run: |
          mkdir -p "Little Helper.app/Contents/MacOS"
          mkdir -p "Little Helper.app/Contents/Resources"
          cp universal/app "Little Helper.app/Contents/MacOS/Little Helper"
          chmod +x "Little Helper.app/Contents/MacOS/Little Helper"

          # Create Info.plist
          cat > "Little Helper.app/Contents/Info.plist" << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>Little Helper</string>
              <key>CFBundleIdentifier</key>
              <string>com.ben.littlehelper</string>
              <key>CFBundleName</key>
              <string>Little Helper</string>
              <key>CFBundleVersion</key>
              <string>1.0.0</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0.0</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>LSMinimumSystemVersion</key>
              <string>10.13</string>
              <key>NSHighResolutionCapable</key>
              <true/>
          </dict>
          </plist>
          EOF

      - name: Create DMG
        run: |
          # Create a folder for DMG contents
          mkdir dmg-contents
          cp -r "Little Helper.app" dmg-contents/
          cp "installer/READ ME FIRST (Mac).txt" dmg-contents/
          ln -s /Applications dmg-contents/Applications

          # Create DMG
          hdiutil create -volname "Little Helper" \
            -srcfolder dmg-contents \
            -ov -format UDZO \
            "LittleHelper.dmg"

      - name: Upload Mac DMG
        uses: actions/upload-artifact@v4
        with:
          name: LittleHelper-Mac
          path: LittleHelper.dmg

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libxcb-render0-dev libxcb-shape0-dev libxcb-xfixes0-dev libxkbcommon-dev libssl-dev pkg-config
          # Needed to run appimagetool (it is an AppImage and wants libfuse.so.2)
          sudo apt-get install -y libfuse2 || sudo apt-get install -y libfuse2t64

      - name: Build Release
        run: cargo build --release

      - name: Create AppDir structure
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          cp target/release/app AppDir/usr/bin/little-helper
          chmod +x AppDir/usr/bin/little-helper

          # Create desktop entry
          cat > AppDir/usr/share/applications/little-helper.desktop << EOF
          [Desktop Entry]
          Name=Little Helper
          Exec=little-helper
          Icon=little-helper
          Type=Application
          Categories=Utility;
          Comment=Your AI assistant for files, fixes, research, and content
          EOF
          
          # Copy desktop entry to AppDir root for AppImage
          cp AppDir/usr/share/applications/little-helper.desktop AppDir/
          
          # Create icon (using a placeholder - you should add your actual icon)
          touch AppDir/usr/share/icons/hicolor/256x256/apps/little-helper.png
          ln -sf usr/share/icons/hicolor/256x256/apps/little-helper.png AppDir/little-helper.png

      - name: Download AppImageTool
        run: |
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool
          chmod +x appimagetool

      - name: Create AppImage
        run: |
          ./appimagetool AppDir LittleHelper.AppImage
          
      - name: Create tarball
        run: |
          tar -czf LittleHelper-Linux.tar.gz -C target/release app
          
      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: LittleHelper-Linux
          path: |
            LittleHelper.AppImage
            LittleHelper-Linux.tar.gz

  create-release:
    needs: [build-windows, build-mac-universal, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: LittleHelper-Windows

      - name: Download Mac Artifact
        uses: actions/download-artifact@v4
        with:
          name: LittleHelper-Mac

      - name: Download Linux Artifact
        uses: actions/download-artifact@v4
        with:
          name: LittleHelper-Linux

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Little Helper ${{ github.ref_name }}
          body: |
            ## Little Helper ${{ github.ref_name }}

            ### Downloads
            - **Windows**: `LittleHelper-Setup.exe` - Double-click to install
            - **Mac (Universal)**: `LittleHelper.dmg` - Works on both Intel and Apple Silicon Macs
            - **Linux**: `LittleHelper.AppImage` - Make executable and run, or use the `.tar.gz`

            ### First Time Opening
            Since this is a beta, you might see a security warning. This is normal!

            **Windows**: Click "More info" → "Run anyway"
            **Mac**: Right-click the app → "Open" → "Open"
            **Linux**: Right-click AppImage → Properties → Permissions → Allow executing as program

            Have fun, and let Ben know what you think!
          files: |
            LittleHelper-Setup.exe
            LittleHelper.dmg
            LittleHelper.AppImage
            LittleHelper-Linux.tar.gz
